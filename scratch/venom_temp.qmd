#This code uses species with Genbank protein sequences labeled 'stonustoxin' to evaluate the relationship between temperature and venom status. Based on [J Scott](https://istmobiome.rbind.io/project/betancur-r-fish-tree/)

##Load Packages
install.packages("tidyverse")
install.packages("webdriver")
install.packages("magrittr")
install.packages("dplyr")
install.packages("rvest")
install.packages("xml2")
install.packages("selectr")
install.packages("tibble")
install.packages("purrr")
install.packages("httr")

library(tidyverse)
library(webdriver)
library(magrittr)
library(dplyr)
library(rvest)
library(xml2)
library(selectr)
library(tibble)
library(purrr)
library(httr)

install_phantomjs

##Import data
raw_dat <- read.csv("data/Stonustoxin_AA_species.csv", header = FALSE)

##Prepare data
dat <- data.frame(unique(raw_dat)) # keep unique species names
nrow(dat) #see how many species remaining

colnames(dat) <- c("Species") #add labels
rownames(dat) <- (1:nrow(dat))
view(dat)

##Scrape fishbase
base_url <- "https://www.fishbase.se/summary/" #locate fishbase

sample_data <- data.frame()

for (Species in dat) {
     tmp_link <- paste(base_url, Species, ".html", sep = "") #create URL
     tmp_entry <- cbind(Species, tmp_link)
     sample_data <- rbind(sample_data, tmp_entry)
     rm(list = ls(pattern = "tmp_"))
}

sample_data <- sample_data %>% dplyr::rename("link" = "tmp_link") # collect names & links

all_links <- sample_data$link #create link vector
all_names <- sample_data$name #create name vector

pjs_instance <- run_phantomjs()
pjs_session <- Session$new(port = pjs_instance$port)

all_fish_data <- data.frame()
for (i in 1:length(all_links)) {
  cat("Downloading", i, "of", length(all_links), "URL:", all_links[i], "\n")
  article <- scrape_fish_base(all_links[i])
  all_fish_data <- rbind(all_fish_data, article)
} ###NOTE: this pulls extra data. In particular, model will have large chunks of text. Modify scrape_fishbase function as necessary. 

##Create and curate data frame
sum_dat <- all_fish_data %>% #create a smaller data frame containing the variables of interest
  select(habitat, threat_to_humans, model_predictions)
colnames(sum_dat) <- c("habitat", "threat_to_humans", "model_predictions") #keep both habitat and model predictions because temperature may be taken from both.
sum_dat<- sum_dat %>% mutate(species = dat$Species, .before = habitat)
view(sum_dat) 

sum_dat <- sum_dat %>% mutate(venom_stat(threat_to_humans), .before = threat_to_humans) # Add column that evaluates 

write.csv(sum_dat, file = "data/sum_dat.csv", row.names = FALSE) # write file. 

## Manual manipulations: REMOVE non-fish species, form column of temperature ranges. 